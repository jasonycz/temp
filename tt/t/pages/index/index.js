window.define("pages/index/index",function(t,e,a,s,i,o,r,n,d,h,l,m,g,u,c,w){"use strict";var _=(t("../../utils/checkin"),t("../../utils/loginUtil")),f=function(t){return t&&t.__esModule?t:{default:t}}(_),p=t("../../utils/networkUtil.js"),C=t("../../utils/util.js"),D=t("../../utils/toHome.js"),b=t("../../utils/parseUtil.js"),S=t("../../utils/abtest/abtest.js"),T=(t("../../utils/userBehavior"),t("../../utils/event.js"));C.init();var x=o(),H=0;Page({data:{commentList:[],status:null,max_id:0,show_loadmore:!0,start_loading:!0,error:!1,error_content:null,show_toggle:!1,show_img:[],blog_id:"",shareImgPath:"",show_bottom_share:!1,showCanvas:!0,max_id_type:0,loadDataFlag:!0,showLaunchApp:!1,showToHome:!1,likeStatus:!1,originAttitudesCount:0,attitudesCount:0,tempLikeStatus:!1,showPullDown:!1,trendsLeft:[],trendsRight:[],trendsLeftHeight:0,trendsRightHeight:0,showMoreComment:!1,commentDetailList:[],trendExt:0,trendMaxId:0,showTrend:-1,trendExpoId:"",trendShowStartTime:"",trendShowEndTime:"",trendLeftHeightArr:[],trendRightHeightArr:[],maxScrollHeight:0,heightWater:0,heightAll:0,heightContent:0,trendShowStartFlag:!0,fromTrend:!1,hasDelete:!1,networkAvailable:!0,isShowLoginDialog:!1,isBirthCard:!0,isAccoutAbnormalDialog:!1,errorType:"",errorMsg:"",gotUserInfo:!1,showCommentBox:!1,targetCommentId:0,targetMid:0,showFakeData:!1,fakeData:{},isReply:"index",placeholder:"写评论",commentId:0,showRepostChoosenToast:!1,repostChoosenToastTop:0,showEntry:!1,placeHolderValue:"",searchExperiment:!0,showTab:!0,videoReady:!1,options:"",indexScheme:"",getStatusFrom:""},onUnload:function(){this.trackTrendExposure(),this.setData({loadDataFlag:!1}),this.clearData(),x.sensors.register({mid:""})},onShow:function(t){this.setData({showToHome:x.globalData.showToHome});getCurrentPages();x.globalData.newLogin&&(this.loadData(this.data.options),x.globalData.newLogin=!1),this.data.fromTrend&&x.sensors.register({detailViewSource:"trend"}),0==this.data.heightAll&&this.getContentHeight()},onLoad:function(t){var e=this;i.setMetaDescription&&i.setMetaDescription({content:"一手明星动态，时下热点事件，搞笑幽默段子微博等你来看。",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),i.setMetaKeywords&&i.setMetaKeywords({content:"微博, 小程序",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),i.setDocumentTitle&&i.setDocumentTitle({title:"微博"}),i.showLoading({title:"加载中"}),T.on("hideIndexTab",this,function(t){e.data.blog_id===t&&e.setData({showTab:!1})}),T.on("showIndexTab",this,function(t){e.data.blog_id===t&&e.setData({showTab:!0})}),this.setData({gotUserInfo:x.globalData.gotUserInfo,loadDataFlag:!0,searchExperiment:"topSearch"===S.getABTestBucket("searchExperiment")}),this.data.options=t,this.data.fromTrend="true"===t.from_trend,this.loadData(t)},onHide:function(){this.trackTrendExposure(),this.data.fromTrend&&x.sensors.register({detailViewSource:""})},trackTrendExposure:function(){if(""!=this.data.trendShowStartTime){this.data.trendShowEndTime=this.data.trendShowEndTime?this.data.trendShowEndTime:Date.parse(new Date);var t=750*this.data.maxScrollHeight/x.globalData.windowWidth,e=this.getShowTrendCardDetail(this.data.trendLeftHeightArr,t,this,"left"),a=this.getShowTrendCardDetail(this.data.trendRightHeightArr,t,this,"right"),s=e.num+a.num,i=e.midArr.concat(a.midArr);s>0&&x.sensors.track("trendContentExposure",{trendShowStartTime:this.data.trendShowStartTime,trendShowEndTime:this.data.trendShowEndTime,trendShowNumber:s,trendShowMID:i,trendExpoId:this.data.trendExpoId})}this.data.trendsLeftHeight=0,this.data.trendsRightHeight=0,this.data.trendShowStartTime="",this.data.trendShowEndTime="",this.data.trendLeftHeightArr=[],this.data.trendRightHeightArr=[],this.data.maxScrollHeight=0,this.data.heightWater=0,this.data.heightAll=0,this.data.heightContent=0},onPageScroll:function(t){var e=t.scrollTop+x.globalData.windowHeight,a=1==this.data.show_toggle?40:0;t.scrollTop>H&&(H=t.scrollTop),this.data.maxScrollHeight=H+x.globalData.windowHeight+a-56-this.data.heightContent;var s=750*(this.data.heightContent-e),i=x.globalData.windowWidth;parseInt(s/i,10)<20&&this.data.trendShowStartFlag&&0!=this.data.heightWater&&(this.data.trendShowStartTime=Date.parse(new Date),this.data.trendShowStartFlag=!1),H>t.scrollTop&&this.data.trendShowStartTime&&e<=this.data.heightContent&&!this.data.trendShowEndTime&&(this.data.trendShowEndTime=Date.parse(new Date))},clearData:function(){this.setData({commentList:[],status:null,max_id:0,show_loadmore:!0,start_loading:!0,error:!1,error_content:null,show_toggle:!1,show_img:[],blog_id:"",shareImgPath:"",show_bottom_share:!1,showCanvas:!0,max_id_type:0,hasDelete:!1,networkAvailable:!0,videoReady:!1,showTab:!0,indexScheme:"",getStatusFrom:""})},loadData:function(t){var e=this;if(t&&!t.blog_id&&(this.data.blog_id="4249456083411688"),t&&t.scene){var a=decodeURIComponent(t.scene),s=C.getUrlParam(a,"blog_id");""!=s&&(this.data.blog_id=s)}this.data.blog_id||(this.data.blog_id=t.blog_id),this.setData({indexScheme:"sinaweibo://detail/?mblogid="+this.data.blog_id+"&luicode=10000360&lfid=miniprogram"}),t&&t.index&&(this.data.index=t.index),this.data.start_loading||this.setData({start_loading:!0}),!this.data.error&&this.data.networkAvailable||this.setData({error:!1,networkAvailable:!0}),x.sensors.register({mid:this.data.blog_id?this.data.blog_id.toString():""}),x.sensors.track("detailView"),f.default.checkUserStatus(function(){p.getComments({blog_id:e.data.blog_id,max_id:e.data.max_id,max_id_type:e.data.max_id_type},e.getCommentsSuccessHandler.bind(e),e.getCommentsFailHandler.bind(e),e.getCommentsCompleteHandler.bind(e)),p.getTrend(e.data.blog_id,e.getTrendSuccessHandler.bind(e),e.getTrendFailHandler.bind(e),e.getTrendCompleteHandler.bind(e)),p.getDefaultSearchValue(x.globalData.uid,e.getDefaultSearchValueSuccessHandler.bind(e),e.getDefaultSearchValueFailHandler.bind(e))})},loadMore:function(t){(this.data.showTrend||this.data.show_loadmore)&&(-1!=this.data.showTrend&&this.data.showTrend?(x.sensors.track("refresh",{refreshType:"loadmore",isRecom:!0}),p.getMoreTrend(this.data.blog_id,this.data.trendMaxId,this.data.trendExt,this.getTrendSuccessHandler.bind(this),this.getTrendFailHandler.bind(this),this.getTrendCompleteHandler.bind(this))):(x.sensors.track("refresh",{refreshType:"loadmore",isRecom:!1}),p.getComments({blog_id:this.data.blog_id,max_id:this.data.max_id,max_id_type:this.data.max_id_type},this.getCommentsSuccessHandler.bind(this),this.getCommentsFailHandler.bind(this),this.getCommentsCompleteHandler.bind(this))))},reload:function(){this.setData({loadDataFlag:!0}),this.loadData()},toggleMore:function(){var t=new Array(this.data.status.mediaContent.showImgList.length);t.fill({show:!0}),this.setData({show_toggle:!1,"status.mediaContent.showImgList":t}),x.sensors.track("contentClick",{clickType:"more"}),this.getContentHeight()},forCatch:function(){},goToCommentSecPage:function(){x.sensors.track("commentSecPageClick"),i.navigateTo({url:"/pages/CommentDetail/CommentDetail?comment_id="+this.data.blog_id+"&fromIndex=true"})},toHome:function(){D.toHome()},onReachBottom:function(){this.loadMore()},onShareAppMessage:function(t){if(this.data.status){var e=this.data.status.retweetedStatus||this.data.status;return b.parseShareMessage(e)}return{}},drawShareImageHandler:function(){this.setData({showCanvas:!1})},getTrendSuccessHandler:function(t){var e=this,a=t.data;if(!a||"-100"!=a.errno&&"-200"!=a.errno){if(!a||a.errno)return}else f.default.updateUserStatus(function(){p.getTrend(e.data.blog_id,e.retryGetTrendSuccessHandler.bind(e),e.getTrendFailHandler.bind(e),e.getTrendCompleteHandler.bind(e))});var s=b.parseTrend(a,this.data.trendsLeftHeight,this.data.trendsRightHeight,this.data.trendLeftHeightArr,this.data.trendRightHeightArr),i=s.trendType,o=s.trendsLeft,r=s.trendsRight;this.data.trendExpoId=this.data.trendExpoId||s.trendExpoId,this.data.trendsLeftHeight=s.trendsLeftHeight,this.data.trendsRightHeight=s.trendsRightHeight,this.data.trendLeftHeightArr=s.trendLeftHeightArr,this.data.trendRightHeightArr=s.trendRightHeightArr,S.setTrendExperiment(s.trendExpId),o.length>0?(this.data.trendExt=0==s.trendExt?this.data.trendExt:s.trendExt,this.data.trendMaxId=s.maxId,o.length>0&&this.setData({showPullDown:!0}),"loadMore"!=i?(this.data.showTrend=!0,this.data.trendsLeft=o,this.data.trendsRight=r):(this.data.trendsLeft=this.data.trendsLeft.concat(o),this.data.trendsRight=this.data.trendsRight.concat(r))):-1==this.data.showTrend&&(this.data.showTrend=!1)},retryGetTrendSuccessHandler:function(t){var e=t.data;e.errno||this.getTrendSuccessHandler(e)},getTrendFailHandler:function(t){this.data.showTrend=!1},getTrendCompleteHandler:function(){this.data.start_loading=!1,this.uploadTrend()},getCommentsCompleteHandler:function(){this.data.start_loading=!1,this.uploadComment()},retryGetCommentsSuccessHandler:function(t){return"-100"==t.errno||"-200"==t.errno?void this.setData({error:!0,error_content:null}):t.errno||0!=t.state_code?void this.setData({error:!0}):void(t.errno&&"1040002"==t.errno?this.setData({error:!0,error_content:null,networkAvailable:!1}):this.getCommentsSuccessHandler(t))},getCommentsSuccessHandler:function(t){var e=this;if(this.data.loadDataFlag){if("-100"==t.errno||"-200"==t.errno)return void f.default.updateUserStatus(function(){p.getComments({blog_id:e.data.blog_id,max_id:e.data.max_id,max_id_type:e.data.max_id_type},e.retryGetCommentsSuccessHandler.bind(e),e.getCommentsFailHandler.bind(e),e.getCommentsCompleteHandler.bind(e))});if(t.status&&t.status.mblogtypename&&null==t.status.mblogtypename)return this.setData({error:""!=this.data.getStatusFrom,needLogin:0==x.globalData.userStatus,getStatusFrom:"statuses/show"}),void p.getStatus(this.data.blog_id,this.getCommentsSuccessHandler.bind(this),this.getCommentsFailHandler.bind(this),this.getCommentsCompleteHandler.bind(this));if(t.errno||0!=t.state_code)return this.setData({error:""!=this.data.getStatusFrom,needLogin:0==x.globalData.userStatus,getStatusFrom:"statuses/show"}),void p.getStatus(this.data.blog_id,this.getCommentsSuccessHandler.bind(this),this.getCommentsFailHandler.bind(this),this.getCommentsCompleteHandler.bind(this));if(t.errno&&"1040002"==t.errno)return void this.setData({error:!0,error_content:null,networkAvailable:!1});if(t&&t.errno&&("20112"==t.errno||"20174"==t.errno))return void this.setData({error:!0,error_content:"暂无查看权限",networkAvailable:!0,hasDelete:!0});if(t&&t.errno&&"20101"==t.errno)return void this.setData({error:!0,error_content:t.errmsg,networkAvailable:!0,hasDelete:!0});if(t.status&&t.status.isLongText&&"true"==t.status.isLongText&&(this.data.show_toggle=!0),-1!=this.data.showTrend&&(this.data.start_loading=!1),null==this.data.status&&t.status){if(0!=t.status.mblog_vip_type||t.status.retweeted_status&&t.status.retweeted_status.mblog_vip_type&&0!=t.status.retweeted_status.mblog_vip_type)return void this.setData({error:!0,error_content:"打开微博客户端，查看全文"});1==t.status.attitudes_status&&(this.data.likeStatus=!0,this.data.tempLikeStatus=!0);var a=b.parseStatus(t.status,!!t.status.retweeted_status,!1),s=new Date,i=s.getFullYear();new Date(t.status.created_at).format("yyyy")==i?a.createdAt=new Date(t.status.created_at).format("MM-dd hh:mm"):a.createdAt=new Date(t.status.created_at).format("yyyy-MM-dd hh:mm"),1==a.showToggleImg&&"video"!=a.mediaContent.mediaType&&(this.data.show_toggle=!0),this.data.error=!1,this.data.status=a,this.data.originAttitudesCount=a.originAttitudesCount,this.data.attitudesCount=a.attitudesCount;var o=this.data.status.mediaContent;if("video"!=a.mediaContent.mediaType)for(var r=0;r<o.showImgList.length;r++)if(!o.showImgList[r].show){this.data.show_toggle=!0,o.showImgList[r]={show:!0};break}var n=this.data.status.retweetedStatus;if(null!=n||n)for(var d=n.mediaContent,h=0;h<d.showImgList.length;h++)if(!d.showImgList[h].show&&"video"!=n.mediaContent.mediaType){this.data.show_toggle=!0,d.showImgList[h]={show:!0};break}var l=this.data.status;l.mediaContent=o,this.data.status=l,"webPage"===l.mediaContent.mediaType&&(this.data.isBirthCard=!1)}var m=!0;if(!t.datas&&t.root_comments&&t.root_comments.length>0&&(t.datas=t.root_comments,m=!1),this.data.show_loadmore=0!=t.max_id&&!!t.datas&&t.datas.length>0,t.datas&&t.datas.length>0){var g=[];t.datas.forEach(function(e,a,s){var i=0;if(m&&(i=e.type,e=e.data),0==i){t.status&&t.status.number_display_strategy&&!e.number_display_strategy&&(e.number_display_strategy=t.status.number_display_strategy);var o=b.parseComment(e);g.push(o)}});var u=g;u.length>3&&(u=u.slice(0,3)),this.data.commentDetailList=this.data.commentDetailList.concat(g),this.data.commentList=this.data.commentList.concat(u),this.data.showMoreComment=this.data.commentDetailList.length>u.length}this.data.max_id=t.max_id?t.max_id:0,this.data.max_id_type=t.max_id_type?t.max_id_type:0}},getCommentsFailHandler:function(t){this.setData({error:!0,error_content:t.errMsg,networkAvailable:!1})},uploadTrend:function(){this.setData({start_loading:this.data.start_loading,trendsLeft:this.data.trendsLeft,trendsRight:this.data.trendsRight,trendExpoId:this.data.trendExpoId,trendExt:this.data.trendExt,trendMaxId:this.data.trendMaxId,showTrend:this.data.showTrend}),i.hideLoading(),this.getContentHeight()},getContentHeight:function(){var t=this;i.createSelectorQuery().select("#main").boundingClientRect(function(e){e&&(t.data.heightAll=e.height),i.createSelectorQuery().select("#water-flow").boundingClientRect(function(e){e&&(t.data.heightWater=e.height,t.data.heightContent=t.data.heightAll-t.data.heightWater)}).exec()}).exec()},getShowTrendCardDetail:function(t,e,a,s){for(var i=[],o=0;o<t.length-1;o++)if("left"==s?i.push(a.data.trendsLeft[o].mid):i.push(a.data.trendsRight[o].mid),t[o]<=e&&t[o+1]>=e)return{num:o+1,midArr:i};return{num:0,midArr:[]}},loadAd:function(){x.sensors.track("adImpression")},adError:function(t){t&&t.detail&&t.detail.errCode&&x.sensors.track("adError",{errorCode:t.detail.errCode,errorMessage:t.detail.errMsg})},uploadComment:function(){this.setData({commentList:this.data.commentList,status:this.data.status,max_id:this.data.max_id,show_loadmore:this.data.show_loadmore,error:this.data.error,error_content:this.data.error_content,show_toggle:this.data.show_toggle,show_img:this.data.show_img,blog_id:this.data.blog_id,shareImgPath:this.data.shareImgPath,show_bottom_share:this.data.show_bottom_share,showCanvas:this.data.showCanvas,max_id_type:this.data.max_id_type,loadDataFlag:this.data.loadDataFlag,showLaunchApp:this.data.showLaunchApp,showToHome:this.data.showToHome,likeStatus:this.data.likeStatus,originAttitudesCount:this.data.originAttitudesCount,attitudesCount:this.data.attitudesCount,tempLikeStatus:this.data.tempLikeStatus,showPullDown:this.data.showPullDown,showMoreComment:this.data.showMoreComment,commentDetailList:this.data.commentDetailList,showTrend:this.data.showTrend,isBirthCard:this.data.isBirthCard}),i.hideLoading()},showCommentDialog:function(t){t.detail.params.from&&"indexReply"==t.detail.params.from?this.setData({showCommentBox:t.detail.params.showCommentBox,isReply:"indexReply",placeholder:t.detail.params.replyName?"回复@"+t.detail.params.replyName:"回复评论",targetCommentId:t.detail.params.targetCommentId,targetMid:t.detail.params.targetMid,commentId:t.detail.params.commentId}):this.setData({showCommentBox:t.detail.params.showCommentBox,isReply:"index",placeholder:"写评论",targetCommentId:this.data.blog_id})},showFakeData:function(t){var e=t.detail.params.fakeData;"index"==this.data.isReply?(this.data.commentList.unshift(e),this.data.commentDetailList.unshift(e),this.setData({commentList:this.data.commentList,commentDetailList:this.data.commentDetailList})):this.setData({showFakeData:!this.data.showFakeData,fakeData:e})},getDefaultSearchValueSuccessHandler:function(t){var e=this;"-100"==t.errno||"-200"==t.errno?f.default.updateUserStatus(function(){p.getDefaultSearchValue(x.globalData.uid,e.retryGetDefaultSearchValueSuccessHandler.bind(e),e.getDefaultSearchValueFailHandler.bind(e))}):t&&t.hotwords&&t.hotwords[0]&&this.setData({placeHolderValue:t.hotwords[0].word?"热搜： "+t.hotwords[0].word:"请输入想要搜索的内容..."})},retryGetDefaultSearchValueSuccessHandler:function(t){"-100"==t.errno||"-200"==t.errno?this.getDefaultSearchValueFailHandler.bind(this):this.getDefaultSearchValueSuccessHandler.bind(this)},getDefaultSearchValueFailHandler:function(t){},loadDom:function(t){this.setData({videoReady:!0})},showTips:function(){i.showModal({content:"小程序暂时不支持此功能哦",showCancel:!1})}})}),window.__swanRoute="pages/index/index",window.usingComponents=["common/Header/Header","common/Error/Error","common/NetworkErrorToast/NetworkErrorToast","common/Content/Content","common/MBlogMedia/MBlogMedia","common/RetweetCard/RetweetCard","common/Comment/Comment","common/WaterPullFlow/WaterPullFlow","common/FooterA/FooterA","common/ToHomeButton/ToHomeButton"],require("pages/index/index");