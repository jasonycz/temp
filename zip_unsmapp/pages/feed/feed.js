window.define("pages/feed/feed",function(t,e,a,s,r,i,n,o,d,c,u,h,l,g,f,D){"use strict";function I(t){return t&&t.__esModule?t:{default:t}}function _(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}var p=t("../../store/index"),E=(t("../../utils/checkin"),t("../../utils/loginUtil")),L=I(E),m=t("../../lib/CyclicTask"),S=(I(m),t("../../utils/networkUtil.js")),T=t("../../utils/parseUtil.js"),R=t("../../utils/event"),w=(t("../../utils/userBehavior.js"),i()),F={PULL_DOWN_REFRESH_ENABLE:0,PULL_DOWN_REFRESH_DISABLE:1,PULL_DOWN_REFRESH_LOADING:2,LOAD_MORE_REFRESH_ENABLE:3,LOAD_MORE_REFRESH_DISABLE:4,LOAD_MORE_REFRESH_LOADING:5},j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE;Page({data:{statusesMap:{},currentIndex:0,refresh:!1,winHeight:w.globalData.realWindowHeight,startLoading:!1,hasMoreData:!1,tabs:[{name:"推荐",tag:"推荐",groupId:"102803",containerId:"102803"},{name:"榜单",tag:"榜单",groupId:"1028038999",containerId:"102803_ctg1_8999_-_ctg1_8999_home"},{name:"明星",tag:"明星",groupId:"1028034288",containerId:"102803_ctg1_4288_-_ctg1_4288"},{name:"搞笑",tag:"搞笑",groupId:"1028034388",containerId:"102803_ctg1_4388_-_ctg1_4388"},{name:"综艺",tag:"综艺",groupId:"1028034688",containerId:"102803_ctg1_4688_-_ctg1_4688"},{name:"情感",tag:"情感",groupId:"1028031988",containerId:"102803_ctg1_1988_-_ctg1_1988"},{name:"电影",tag:"电影",groupId:"1028033288",containerId:"102803_ctg1_3288_-_ctg1_3288"},{name:"社会",tag:"社会",groupId:"1028034188",containerId:"102803_ctg1_4188_-_ctg1_4188"},{name:"电视剧",tag:"电视剧",groupId:"1028032488",containerId:"102803_ctg1_2488_-_ctg1_2488"},{name:"音乐",tag:"音乐",groupId:"1028035288",containerId:"102803_ctg1_5288_-_ctg1_5288"},{name:"时尚",tag:"时尚",groupId:"1028034488",containerId:"102803_ctg1_4488_-_ctg1_4488"},{name:"游戏",tag:"游戏",groupId:"1028034888",containerId:"102803_ctg1_4888_-_ctg1_4888"},{name:"数码",tag:"数码",groupId:"1028035088",containerId:"102803_ctg1_5088_-_ctg1_5088"},{name:"旅游",tag:"旅游",groupId:"1028032588",containerId:"102803_ctg1_2588_-_ctg1_2588"},{name:"美妆",tag:"美妆",groupId:"1028031588",containerId:"102803_ctg1_1588_-_ctg1_1588"}],refreshType:"auto",canIUseAnimationfinish:r.canIUse("swiper.bindanimationfinish"),isShowLoginDialog:!1,isAccoutAbnormalDialog:!1,errorType:"",errorMsg:"",showToLoad:!1,showCommentBox:!1,commentBlogId:"",showCanvas:!1,showRepostChoosenToast:!1,repostChoosenToastTop:0,showEntry:!1,placeHolderValue:"",searchShow:!0,feedListInfo:{}},jsData:{statuses:[],maxId:0,groupId:"102803",containerId:"102803",firstIdList:[],focusSinceId:0,focusMaxId:0,getDataFromMainApp:!1,mainAppFocusSinceId:0,mainAppFocusMaxId:0,isFirstRequest:!0,switchingTab:!1,lfid:"",ipTestPkShareInfo:null,remindUnreadTaskHandle:null,newRecommendIndex:1},onLoad:function(t){var e=this;r.setMetaDescription&&r.setMetaDescription({content:"一手明星动态，时下热点事件，搞笑幽默段子微博等你来看。",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),r.setMetaKeywords&&r.setMetaKeywords({content:"微博, 小程序",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),r.setDocumentTitle&&r.setDocumentTitle({title:"微博"}),"pk"===t.activity&&w.sensors.track("IPShowFromActivity",{luicode:t.luicode||"",fromUid:t.fromUid||""}),R.on("ipTestPkShareInfo",this,function(t){e.jsData.ipTestPkShareInfo=t||null}),this.changeTab(this.data.currentIndex)},onShow:function(){var t=this,e={isShowLoginDialog:!1},a=this.data.statusesMap[this.data.currentIndex];if(a&&a.statuses){var s=this.data.statusesMap[this.data.currentIndex].statuses,r="statusesMap["+this.data.currentIndex+"]";(0,p.calcData)(s)&&this.setData(_({},r,this.data.statusesMap[this.data.currentIndex]))}this.setData(e),w.sensors.register({fid:this.data.containerId,lfid:""}),L.default.checkUserStatus(function(){S.getDefaultSearchValue(w.globalData.uid,t.getDefaultSearchValueSuccessHandler.bind(t),t.getDefaultSearchValueFailHandler.bind(t))})},onHide:function(){w.sensors.register({lfid:this.jsData.containerId,fid:""})},onPullDownRefresh:function(){if(this.jsData.isFirstRequest=!1,j===F.PULL_DOWN_REFRESH_ENABLE){j=F.PULL_DOWN_REFRESH_LOADING,this.setData({refresh:!0,refreshType:"pulldown"}),w.sensors.track("refresh",{refreshType:"pull"});var t={currentIndex:this.data.currentIndex,groupId:this.jsData.groupId,containerId:this.jsData.containerId,maxId:this.jsData.maxId,refreshType:this.data.refreshType,fid:this.jsData.containerId,lfid:this.jsData.lfid};S.getHotTimeline(t,this.getFeedSuccessHandler.bind(this),this.getFeedFailHandler.bind(this))}},onReachBottom:function(t){this.scrollBottom()},scrollBottom:function(){if(this.jsData.isFirstRequest=!1,!(H!==F.LOAD_MORE_REFRESH_ENABLE||this.data.error||"focus"==this.jsData.groupId&&1==this.data.showToLoad)){H=F.LOAD_MORE_REFRESH_LOADING,w.sensors.track("refresh",{refreshType:"loadmore"}),this.setData({refreshType:"loadmore"});var t={currentIndex:this.data.currentIndex,groupId:this.jsData.groupId,containerId:this.jsData.containerId,maxId:this.jsData.maxId,refreshType:this.data.refreshType,fid:this.jsData.containerId,lfid:this.jsData.lfid};S.getHotTimeline(t,this.getFeedSuccessHandler.bind(this),this.getFeedFailHandler.bind(this))}},shouldAbortFeed:function(t,e){return t!=e},tabIndexChanged:function(t){r.stopPullDownRefresh(),this.changeTab(t.detail.params.currentIndex)},changeTab:function(t){if(r.hideLoading(),this.setData({refreshType:"auto",refresh:!1}),r.pageScrollTo({scrollTop:0}),t>=0&&t<this.data.tabs.length){this.setData({currentIndex:t,hasMoreData:!1});var e=this.data.tabs[t];this.jsData.groupId=e.groupId,this.jsData.lfid=""==this.jsData.lfid&&this.jsData.containerId==e.containerId?"":this.jsData.containerId,this.jsData.containerId=e.containerId,"focus"!=this.jsData.groupId&&1==this.data.showToLoad&&this.setData({showToLoad:!1}),w.sensors.register({fid:e.containerId}),w.sensors.track("flowView"),w.sensors.track("refresh",{refreshType:"clicktab"}),this.data.statusesMap[t]&&this.data.statusesMap[t].statuses||(r.showLoading({title:"加载中"}),this.reloadPageData())}},pullDownFailHandler:function(){r.stopPullDownRefresh(),this.setData({refresh:!1}),r.showToast({title:"网络出错啦",icon:"none",image:"../../static/resources/images/empty_failed.png",duration:2e3})},retryGetFeedSuccessHandler:function(t,e,a){!a.errno||"-100"!=a.errno&&"-200"!=a.errno?a.errno||a.state_code&&0!=a.state_code?(j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE,"pulldown"==this.data.refreshType?this.pullDownFailHandler():(this.setData({startLoading:!1,error:!0}),r.hideLoading())):this.getFeedSuccessHandler(t,e,a):(j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE,"pulldown"==this.data.refreshType?this.pullDownFailHandler():(this.setData({startLoading:!1,error:!0}),r.hideLoading()))},getFeedFailHandler:function(t){j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE,"pulldown"==this.data.refreshType?this.pullDownFailHandler():(this.setData({startLoading:!1,error:!0}),r.hideLoading())},getFeedSuccessHandler:function(t,e,a){var s=this;if(!this.shouldAbortFeed(t,this.data.currentIndex)){if(a.errno&&("-100"==a.errno||"-200"==a.errno))return void L.default.updateUserStatus(function(){var t={currentIndex:s.data.currentIndex,groupId:s.jsData.groupId,containerId:s.jsData.containerId,maxId:s.jsData.maxId,refreshType:s.data.refreshType,fid:s.jsData.containerId,lfid:s.jsData.lfid};S.getHotTimeline(t,s.retryGetFeedSuccessHandler.bind(s),s.getFeedFailHandler.bind(s))});if(a.errno||a.state_code&&0!=a.state_code)return j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE,void("pulldown"==this.data.refreshType?this.pullDownFailHandler():(this.setData({startLoading:!1,error:!0}),r.hideLoading()));j=F.PULL_DOWN_REFRESH_ENABLE,H=F.LOAD_MORE_REFRESH_ENABLE,this.setData({error:!1,startLoading:!1}),r.hideLoading();var i=T.parseStatuses(a,"fromFeed");this.data.feedListInfo=i,this.saveStatusesWithTabStatus(t,e,i)}},getDefaultSearchValueSuccessHandler:function(t){var e=this;"-100"==t.errno||"-200"==t.errno?L.default.updateUserStatus(function(){S.getDefaultSearchValue(w.globalData.uid,e.retryGetDefaultSearchValueSuccessHandler.bind(e),e.getDefaultSearchValueFailHandler.bind(e))}):t&&t.hotwords&&t.hotwords[0]&&this.setData({placeHolderValue:t.hotwords[0].word?"热搜： "+t.hotwords[0].word:"请输入想要搜索的内容..."})},retryGetDefaultSearchValueSuccessHandler:function(t){"-100"==t.errno||"-200"==t.errno?this.getDefaultSearchValueFailHandler(t):this.getDefaultSearchValueSuccessHandler(t)},getDefaultSearchValueFailHandler:function(t){},reloadPageData:function(){var t=this;this.setData({startLoading:!0,error:!1}),this.jsData.maxId=0,0==this.data.currentIndex&&"auto"==this.data.refreshType&&setTimeout(function(){if(!(0!=t.data.currentIndex||"auto"!=t.data.refreshType||t.data.statusesMap[t.data.currentIndex]&&t.data.statusesMap[t.data.currentIndex].statuses)){var e={currentIndex:t.data.currentIndex,groupId:t.jsData.groupId,containerId:t.jsData.containerId,maxId:t.jsData.maxId,refreshType:t.data.refreshType,fid:t.jsData.containerId,lfid:t.jsData.lfid};S.getHotTimeline(e,t.getFeedSuccessHandler.bind(t),t.getFeedFailHandler.bind(t))}},2e3),L.default.checkUserStatus(function(){var e={currentIndex:t.data.currentIndex,groupId:t.jsData.groupId,containerId:t.jsData.containerId,maxId:t.jsData.maxId,refreshType:t.data.refreshType,fid:t.jsData.containerId,lfid:t.jsData.lfid};S.getHotTimeline(e,t.getFeedSuccessHandler.bind(t),t.getFeedFailHandler.bind(t))})},loadData:function(){"auto"==this.data.refreshType?this.reloadPageData():"pulldown"==this.data.refreshType?(this.setData({error:!1}),this.onPullDownRefresh()):(this.setData({error:!1}),this.scrollBottom())},saveStatusesWithTabStatus:function(t,e,a){if(!this.shouldAbortFeed(t,this.data.currentIndex)){var s=this.data.statusesMap;if(a.statuses&&a.statuses.length>0)if(this.setData({hasMoreData:!0}),"auto"==e){this.jsData.maxId=a.maxId,this.jsData.statuses=a.statuses;var i=a.statuses[0].blogId;this.jsData.firstIdList=i?this.jsData.firstIdList.concat(i):this.jsData.firstIdList;var n=void 0;n=s[t]&&s[t].statuses?s[t].statuses.concat(this.jsData.statuses):this.jsData.statuses,this.setData(_({startLoading:!1},"statusesMap."+t,{statuses:n,scrollTop:0})),r.hideLoading()}else if("pulldown"==e){var o=[];s[t]&&s[t].statuses&&(o=s[t].statuses),this.jsData.statuses=a.statuses.concat(o),this.jsData.maxId=a.maxId,this.jsData.firstIdList=this.jsData.firstIdList.concat(a.statuses[0].blogId),this.setData(_({},"statusesMap."+t,{statuses:this.jsData.statuses,scrollTop:0})),r.stopPullDownRefresh(),this.setData({refresh:!1}),j=F.PULL_DOWN_REFRESH_ENABLE}else if(a.statuses[0].blogId&&-1==this.jsData.firstIdList.indexOf(a.statuses[0].blogId)){var d=[];s[t]&&s[t].statuses&&(d=s[t].statuses),this.jsData.statuses=d.concat(a.statuses),this.jsData.maxId=a.maxId,this.jsData.firstIdList=this.jsData.firstIdList.concat(a.statuses[0].blogId),this.setData(_({},"statusesMap."+t,{statuses:this.jsData.statuses,scrollTop:s[t].scrollTop?s[t].scrollTop:0}))}else this.setData({hasMoreData:!1});else this.setData({startLoading:!1,hasMoreData:!1,refresh:!1}),r.hideLoading()}},beforeSwitchTab:function(t){if(0===t.detail.current&&this.data.currentIndex>1)return void this.setData({currentIndex:this.data.currentIndex});t.detail.current!=this.data.currentIndex&&"touch"===t.detail.source&&(this.jsData.switchingTab=!0,this.setData({currentIndex:t.detail.current}))},switchTab:function(t){var e=this;this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){if(0===t.detail.current&&e.data.currentIndex>1)return void e.changeTab(e.data.currentIndex);(e.jsData.switchingTab||t.detail.current!=e.data.currentIndex&&"touch"===t.detail.source)&&(e.jsData.switchingTab=!1,e.changeTab(t.detail.current))},30)},onShareAppMessage:function(t){if("menu"==t.from||"menu"==t.from.from)return{title:"邀请您使用微博发现新鲜事",content:"看最新资讯就上新浪微博",imageUrl:"https://h5.sinaimg.cn/upload/100/843/2018/11/22/weibo_icon.png",path:"/pages/feed/feed"};var e=t.from.target||t.target,a=e.target.dataset.card;return T.parseShareMessage(a)},goSearchPage:function(){r.navigateTo({url:"/pages/hotSearch/hotSearch?searchValue="+this.data.placeHolderValue.substring(3)})}})}),window.__swanRoute="pages/feed/feed",window.usingComponents=["common/FeedList/FeedList","common/TabBar/TabBar","common/NetworkErrorToast/NetworkErrorToast","common/NetworkErrorItem/NetworkErrorItem"],require("pages/feed/feed");