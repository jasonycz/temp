window.define("pages/topic/topic",function(t,e,a,o,i,s,n,r,c,d,p,h,l,u,g,m){"use strict";function T(t){return t&&t.__esModule?t:{default:t}}var f=t("../../store/index"),D=t("../../utils/loginUtil"),S=T(D),w=t("../../canvas/topic"),v=T(w),L=t("../../utils/networkUtil.js"),C=t("../../utils/parseUtil.js"),H=t("../../utils/util.js"),M=(t("../../utils/event.js"),t("../../utils/userBehavior.js"),s()),b="";Page({data:{hasMoreData:!0,containerid:"",page:1,superTopic:{},statuses:[],error:!1,contentSet:"",startLoading:!1,isShowLoginDialog:!1,isAccoutAbnormalDialog:!1,errorType:"",errorMsg:"",refreshType:"auto",showCommentBox:!1,commentBlogId:0,contentHeight:M.globalData.realWindowHeight,showRepostChoosenToast:!1,repostChoosenToastTop:0,topicContent:"",topicSheme:"",showLaunchApp:!1,showToHome:!1,topicShareCvsId:"topic-share",topicShareCvsWidth:420,topicShareCvsHeight:336,topicShareImagePath:"",needLogin:!1},onLoad:function(t){i.setMetaDescription&&i.setMetaDescription({content:"一手明星动态，时下热点事件，搞笑幽默段子微博等你来看。",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),i.setMetaKeywords&&i.setMetaKeywords({content:"微博, 小程序",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),i.setDocumentTitle&&i.setDocumentTitle({title:"微博"});var e=H.getUrlParam(decodeURIComponent(t.containerid),"q");this.setData({topicSheme:"sinaweibo://searchall?containerid=231522&luicode=10000360&lfid=miniprogram&q="+encodeURIComponent(e)}),t&&t.topicContent&&(b=t.topicContent),this.data.contentSet=new Set,this.data.containerid=decodeURI(t.containerid),i.showLoading({title:"加载中"}),this.loadData()},onShow:function(){this.setData({isShowLoginDialog:!1,showLaunchApp:M.globalData.launchFromApp,showToHome:M.globalData.launchFromMiniProgram||M.globalData.launchFromApp});var t=this.data.statuses;if(t.length){var e=(0,f.calcData)(t);e&&this.setData({statuses:e})}},onHide:function(){},loadData:function(){var t=this;"auto"==this.data.refreshType?(this.setData({startLoading:!0,error:!1}),S.default.checkUserStatus(function(){L.getTopic(t.data.containerid,t.data.page,"topicPageLoad",t.getTopicSucess.bind(t),t.getTopicFailHandler.bind(t))})):(this.setData({error:!1}),this.data.hasMoreData&&this.onReachBottom())},onReachBottom:function(){var t=this;this.data.hasMoreData&&!this.data.error&&(this.setData({refreshType:"loadmore"}),this.data.page=this.data.page+1,S.default.checkUserStatus(function(){L.getTopic(t.data.containerid,t.data.page,void 0,t.getTopicSucess.bind(t),t.getTopicFailHandler.bind(t))}))},onShareAppMessage:function(t){if("menu"==t.from||"menu"==t.from.from)return{title:"分享"+this.data.superTopic.title,content:this.data.superTopic.discussNum,imageUrl:this.data.superTopic.icon,path:"/pages/topic/topic?containerid="+encodeURIComponent(encodeURIComponent(this.data.containerid))};var e=t.from.target||t.target,a=e.target.dataset.card;return C.parseShareMessage(a)},getTopicSucess:function(t){var e=this;if(t&&t.data&&("-100"==t.data.errno||"-200"==t.data.errno))S.default.updateUserStatus(function(){"auto"==e.data.refreshType?(e.setData({startLoading:!0,error:!1}),L.getTopic(e.data.containerid,e.data.page,"topicPageLoad",e.retryGetTopicSuccessHandler.bind(e),e.getTopicFailHandler.bind(e))):(e.setData({error:!1}),e.data.hasMoreData&&L.getTopic(e.data.containerid,e.data.page,void 0,e.retryGetTopicSuccessHandler.bind(e),e.getTopicFailHandler.bind(e)))});else if(t&&t.data&&void 0!=t.data.errno||void 0!=t.data.state_code&&0!=t.data.state_code)this.setData({startLoading:!1,error:!0}),i.hideLoading();else{var a=C.parseTopic(t.data,"topicPageLoad");"needLogin"==a.errMsg?this.setData({startLoading:!1,superTopic:a.topicDetail,hasMoreData:!1,needLogin:!0,error:!0,errorMsg:"暂无查看权限"}):void 0==a.timeline.statuses?this.setData({startLoading:!1,superTopic:a.topicDetail,hasMoreData:!1}):this.setData({startLoading:!1,superTopic:a.topicDetail,hasMoreData:!(a.timeline.statuses.length<5),statuses:this.data.statuses.concat(H.removeRepeatedBlog(a.timeline.statuses,this.data.contentSet))}),this.drawTopicShare(),i.hideLoading()}},retryGetTopicSuccessHandler:function(t){t&&t.data&&void 0!=t.data.errno&&("-100"==t.data.errno||"-200"==t.data.errno)?this.getTopicFailHandler():this.getTopicSucess(t)},getTopicFailHandler:function(t){this.setData({startLoading:!1,error:!0}),i.hideLoading()},scrolling:function(t){t.detail.scrollTop>100?this.setData({topicContent:decodeURIComponent(b)}):this.setData({topicContent:""})},drawTopicShare:function(){var t=this,e=this.data.superTopic;(0,v.default)(this,this.data.topicShareCvsId,this.data.topicShareCvsWidth,this.data.topicShareCvsHeight,{topic:e.title,pic:e.icon,descArr:[e.readNum,e.discussNum]}).then(function(e){t.setData({topicShareImagePath:e})}).catch(function(t){})}})}),window.__swanRoute="pages/topic/topic",window.usingComponents=["common/FeedList/FeedList","common/NetworkErrorToast/NetworkErrorToast","common/NetworkErrorItem/NetworkErrorItem","common/ToHomeButton/ToHomeButton"],require("pages/topic/topic");