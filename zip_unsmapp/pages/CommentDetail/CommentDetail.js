window.define("pages/CommentDetail/CommentDetail",function(t,e,a,o,s,i,n,m,d,r,l,c,h,_,u,g){"use strict";var f=t("../../utils/loginUtil"),p=function(t){return t&&t.__esModule?t:{default:t}}(f),y=t("../../utils/networkUtil.js"),D=t("../../utils/util.js"),x=t("../../utils/parseUtil.js"),C=i();D.init(),Page({data:{root_comment:{},commentList:[],max_id:0,show_loadmore:!0,start_loading:!0,comment_id:"",max_id_type:0,isShowLoginDialog:!1,isAccoutAbnormalDialog:!1,errorType:"",errorMsg:"",fromIndex:!1,mid:"",showCommentBox:!1,targetCommentId:"",targetMid:"",contentHeight:C.globalData.realWindowHeight,replyName:"",fromMsg:!1},onLoad:function(t){s.setMetaDescription&&s.setMetaDescription({content:"一手明星动态，时下热点事件，搞笑幽默段子微博等你来看。",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),s.setMetaKeywords&&s.setMetaKeywords({content:"微博, 小程序",success:function(t){console.log("设置成功")},fail:function(t){console.log("设置失败"),console.log(t)}}),s.setDocumentTitle&&s.setDocumentTitle({title:"微博"}),t.mid&&this.setData({mid:t.mid}),t.fromMsg&&this.setData({fromMsg:!0}),t.fromIndex?this.setData({start_loading:!0,fromIndex:t.fromIndex,comment_id:t.comment_id}):this.setData({comment_id:t.comment_id}),s.showLoading({title:"加载中"}),this.loadMore()},onShow:function(){this.setData({isShowLoginDialog:!1})},onReachBottom:function(){this.loadMore()},loadMore:function(){if(this.data.show_loadmore){this.data.show_loadmore=!1,C.sensors.track("refresh",{refreshType:"loadmore"});var t={blog_id:this.data.comment_id,max_id:this.data.max_id,max_id_type:this.data.max_id_type,fetch_level:this.data.fromIndex?0:1};console.log(t),y.getComments(t,this.getCommentsSuccessHandler.bind(this),this.getCommentsFailHandler.bind(this))}},retryGetCommentsSuccessHandler:function(t){this.data.start_loading&&this.setData({start_loading:!1}),!t||"-100"!=t.errno&&"-200"!=t.errno?this.getCommentsSuccessHandler(t):this.getCommentsFailHandler(t)},getCommentsSuccessHandler:function(t){var e=this;if(this.data.start_loading&&this.setData({start_loading:!1}),t&&("-100"==t.errno||"-200"==t.errno))return this.setData({show_loadmore:!0}),void p.default.updateUserStatus(function(){var t={blog_id:e.data.comment_id,max_id:e.data.max_id,max_id_type:e.data.max_id_type,fetch_level:e.data.fromIndex?0:1};y.getComments(t,e.getCommentsSuccessHandler.bind(e),e.getCommentsFailHandler.bind(e))});if(this.setData({show_loadmore:0!=t.max_id}),this.data.fromMsg&&(!t||t.state_code&&0!=t.state_code))return s.showToast({title:"抱歉，此评论已被删除",icon:"none",duration:1500,mask:!0}),void setTimeout(function(){s.navigateBack({delta:1})},1500);if(!this.data.fromIndex&&void 0!=t.rootComment){var a=t.rootComment;t.status&&t.status.number_display_strategy&&!a.number_display_strategy&&(a.number_display_strategy=t.status.number_display_strategy);var o=x.parseStatus(a,!(void 0==a.retweeted_status),!1),i={id:a.id.toString(),time:new Date(a.created_at).format("MM-dd hh:mm"),content:a.text,cardContentList:o.cardContentList,like_status:a.liked,origin_like_counts:a.like_counts,like_counts:a.attitudesCount,uid:a.user.id,name:a.user.screen_name,head_img:a.user.profile_image_url};this.setData({root_comment:i}),s.hideLoading()}this.data.fromIndex&&void 0==t.datas&&void 0!=t.root_comments&&t.root_comments.length>0&&(t.datas=t.root_comments);var n=this.data.fromIndex?t.datas:t.comments;if(void 0!=n&&n.length>0){for(var m=[],d=0;d<n.length;d++){var r=n[d],l=void 0==r.data?r:r.data;if(!this.data.fromIndex||this.data.fromIndex&&void 0==r.type||this.data.fromIndex&&void 0!=r.type&&0==r.type){t.status&&t.status.number_display_strategy&&!l.number_display_strategy&&(l.number_display_strategy=t.status.number_display_strategy);var c=x.parseComment(l);m[d]=c}}this.setData({commentList:this.data.commentList.concat(m)}),s.hideLoading()}this.setData({max_id:t.max_id,max_id_type:void 0==t.max_id_type?0:t.max_id_type})},getCommentsFailHandler:function(t){s.hideLoading(),this.setData({show_loadmore:!0})},showFakeData:function(t){var e=t.detail.params.fakeData;if(this.data.root_comment&&this.data.root_comment.id==this.data.targetCommentId)this.data.commentList.unshift(e),this.setData({commentList:this.data.commentList});else for(var a=0;a<this.data.commentList.length;a++)if(this.data.commentList[a].id==this.data.targetCommentId){this.data.fromIndex?(this.data.commentList[a].comments?this.data.commentList[a].comments.unshift(e):this.data.commentList[a].comments=[e],this.data.commentList[a].more=!0):this.data.commentList.unshift(e),this.setData({commentList:this.data.commentList});break}}})}),window.__swanRoute="pages/CommentDetail/CommentDetail",window.usingComponents=["common/Comment/Comment","common/Error/Error"],require("pages/CommentDetail/CommentDetail");